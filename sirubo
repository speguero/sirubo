#!/bin/sh

main()
{
	# = VARS =>

	set -u
	set -e
	umask u=rw,go=

	local list_asn=""
	local name_program="sirubo"
	local fpath_conf="/usr/local/etc/$name_program.conf"
	local whoisdomain="whois.radb.net"  # WHOIS domain to query for ASN prefixes.

	if [ "$(uname -s)" = "OpenBSD" ]
	then
		local fpath_ruleset="/usr/local/etc/pf.$name_program.conf"
	fi

	if [ "$(uname -s)" = "Linux" ]
	then
		local fpath_ruleset="/usr/local/etc/$name_program.ruleset"
		local fname_service="$name_program.service"
	fi

	# = ARGS =>

	[ "$*" = "" ] &&
	{
		print_help
		exit 1
	}

	[ "$*" = "help" ] &&
	{
		print_help
		exit 1
	}
	
	confirm_root_access                 || exit $?
	confirm_prerequisites "$fpath_conf" || exit $?

	[ "$*" = "create" ] &&
	{
		# Import Program Configuration File:

		list_asn="$(cat "$fpath_conf" | egrep -o "^AS[^ ]+")"

		# Create Firewall Ruleset Configuration File:

		if [ "$(uname -s)" = "OpenBSD" ]
		then
			# Create Anchor in pf.conf:

			cat /etc/pf.conf | egrep -q "^anchor $name_program$" || {
				printf "anchor $name_program" >> "/etc/pf.conf"
			}

			# Create Ruleset:

			touch "$fpath_ruleset.tmp"

			# Wait for Network Connection if Not Present:
			
			confirm_network_connection "$whoisdomain"

			# Verify Existence of Specified ASNs:

			confirm_asn "$whoisdomain" "$list_asn"

			# Perform WHOIS Query of ASN for Associated Prefixes:

			list_prefixes_ipv4="$(print_prefixes_ipv4 "$whoisdomain" "$list_asn")"
			list_prefixes_ipv6="$(print_prefixes_ipv6 "$whoisdomain" "$list_asn")"

			# Add Rules to Reject ASN Prefixes:

			[ $(printf "$list_prefixes_ipv4" | wc -l | tr -d "[:blank:]") -ne 0 ] &&
			{
				echo "$list_prefixes_ipv4" | while IFS= read -r prefix
				do
					printf "block return on any inet from any to $prefix\n" >> "$fpath_ruleset.tmp"
				done
			}

			[ $(printf "$list_prefixes_ipv6" | wc -l | tr -d "[:blank:]") -ne 0 ] &&
			{
				echo "$list_prefixes_ipv6" | while IFS= read -r prefix
				do
					printf "block return on any inet from any to $prefix\n" >> "$fpath_ruleset.tmp"
				done
			}

			# Create Service for Ruleset Persistency:

			# Load Ruleset:

			mv -f "$fpath_ruleset" "$fpath_ruleset.backup"
			mv -f "$fpath_ruleset.tmp" "$fpath_ruleset"

			pfctl -a "$name_program" -f "$fpath_ruleset"
		fi

		if [ "$(uname -s)" = "Linux" ]
		then
			# Create Ruleset:

			touch "$fpath_ruleset.tmp"

			printf "#!/usr/sbin/nft -f\n\n"                                                                               >> "$fpath_ruleset.tmp"
			printf "add table inet $name_program\n"                                                                       >> "$fpath_ruleset.tmp"
			printf "flush table inet $name_program\n"                                                                     >> "$fpath_ruleset.tmp"
			printf "add chain inet $name_program $name_program { type filter hook output priority 0 ; policy accept; }\n" >> "$fpath_ruleset.tmp"

			# Wait for Network Connection if Not Present:
			
			confirm_network_connection "$whoisdomain"

			# Verify Existence of Specified ASNs:

			confirm_asn "$whoisdomain" "$list_asn"

			# Perform WHOIS Query of ASN for Associated Prefixes:

			list_prefixes_ipv4="$(print_prefixes_ipv4 "$whoisdomain" "$list_asn")"
			list_prefixes_ipv6="$(print_prefixes_ipv6 "$whoisdomain" "$list_asn")"

			#list_ipblock_4=$(
			#	echo "$list_asn" | while IFS= read -r asn
			#	do
			#		whois -h "$whoisdomain" -i origin "$asn" | egrep '^route\:' | awk '{print $2}'
			#	done
			#)
			#
			#list_ipblock_6=$(
			#	echo "$list_asn" | while IFS= read -r asn
			#	do
			#		whois -h "$whoisdomain" -i origin "$asn" | egrep '^route6\:' | awk '{print $2}'
			#	done
			#)

			# Add Rules to Reject ASN Prefixes:

			[ $(printf "$list_prefixes_ipv4" | wc -l) -ne 0 ] &&
			{
				echo "$list_prefixes_ipv4" | while IFS= read -r prefix
				do
					printf "add rule inet $name_program $name_program ip daddr $prefix reject\n" >> "$fpath_ruleset.tmp"
				done
			}

			[ $(printf "$list_prefixes_ipv6" | wc -l) -ne 0 ] &&
			{
				echo "$list_prefixes_ipv6" | while IFS= read -r prefix
				do
					printf "add rule inet $name_program $name_program ip6 daddr $prefix reject\n" >> "$fpath_ruleset.tmp"
				done
			}

			# Create Service for Ruleset Persistency:

			print_linux_systemd_unit_file "$name_program" "$fpath_ruleset" > "/etc/systemd/system/$fname_service"
			systemctl -q daemon-reload
			systemctl -q reenable "$fname_service"

			# Load Ruleset:

			mv -f "$fpath_ruleset" "$fpath_ruleset.backup"
			mv -f "$fpath_ruleset.tmp" "$fpath_ruleset"

			nft -f "$fpath_ruleset"
		fi

		exit
	}

	[ "$*" = "resume" ] &&
	{
		if [ "$(uname -s)" = "OpenBSD" ]
		then
			# COMMAND TO RESTORE SERVICE
			pfctl -a "$name_program" -f "$fpath_ruleset"
		fi

		if [ "$(uname -s)" = "Linux" ]
		then
			systemctl -q enable "$fname_service"
			nft -f "$fpath_ruleset"
		fi

		exit
	}

	[ "$*" = "stop" ] &&
	{
		if [ "$(uname -s)" = "OpenBSD" ]
		then
			# COMMAND TO REMOVE SERVICE
			pfctl -a "$name_program" -F rules 1> /dev/null
		fi

		if [ "$(uname -s)" = "Linux" ]
		then
			systemctl -q disable "$fname_service"
			nft delete table inet "$name_program" 2> /dev/null
		fi

		exit
	}
}

confirm_asn()
{
	local whoisdomain="$1"
	local list_asn="$2"

	echo "$list_asn" | while IFS= read -r asn
	do
		whois -h "$whoisdomain" -i origin "$asn" | egrep -q '^route\:' || {
			>&2 printf "> warn: ASN \"%s\" did not return IPv4 results.\n" "$asn"
		}

		whois -h "$whoisdomain" -i origin "$asn" | egrep -q '^route6\:' || {
			>&2 printf "> warn: ASN \"%s\" did not return IPv6 results.\n" "$asn"
		}
	done
}

confirm_network_connection()
{
	local ping_loop=0
	local whoisdomain="$1"

	until ping -q -c 1 "$whoisdomain" > /dev/null 2>&1
	do
		ping_loop=1
		printf "  info: Cannot ping \"%s\". Will not proceed until I can...\r" "$whoisdomain"
		sleep 1
	done

	if [ $ping_loop = 1 ]
	then
		printf "\n"
	fi
}

confirm_prerequisites()
{
	[ -f "$1" ] || {
		printf "  info: Creating configuration file at \"%s\". Specify at least one ASN before continuing.\n" "$1"
		touch "$1" && \
			chown 0:0 "$1" && \
			chmod 600 "$1"
		return 1
	}

	cat "$1" | egrep -qo "^AS[^ ]+" || {
		>&2 printf "> error: Configuration file (%s) does not contain at least one ASN. Specify before continuing.\n" "$1"
		return 2
	}

	uname -s | grep -q "OpenBSD" && {

		which pfctl 2>&1 > /dev/null || {
			>&2 printf "> error: \"pfctl\" is a prerequisite and was not found.\n"
			return 2
		}

		which whois 2>&1 > /dev/null || {
			>&2 printf "> error: \"whois\" is a prerequisite and was not found.\n"
			return 2
		}
	}

	uname -s | grep -q "Linux" && {

		which nft 2>&1 > /dev/null || {
			>&2 printf "> error: \"nft\" is a prerequisite and was not found.\n"
			return 2
		}

		which systemd 2>&1 > /dev/null || {
			>&2 printf "> error: \"systemd\" is a prerequisite and was not found.\n"
			return 2
		}

		which whois 2>&1 > /dev/null || {
			>&2 printf "> error: \"whois\" is a prerequisite and was not found.\n"
			return 2
		}
	}

	return 0
}

confirm_root_access()
{
	if [ `id -u` -ne 0 ]
	then
		>&2 printf "> error: $(basename "$0") not running as root.\n"
		return 2
	fi
}

print_prefixes_ipv4()
{
	local whoisdomain="$1"
	local list_asn="$2"

	echo "$list_asn" | while IFS= read -r asn
	do
		whois -h "$whoisdomain" -i origin "$asn" | egrep '^route\:' | awk '{print $2}'
	done
}

print_prefixes_ipv6()
{
	local whoisdomain="$1"
	local list_asn="$2"

	echo "$list_asn" | while IFS= read -r asn
	do
		whois -h "$whoisdomain" -i origin "$asn" | egrep '^route6\:' | awk '{print $2}'
	done
}

print_help()
{
	cat <<EOF
Usage: $(basename "$0") [command]

  help      This very message.
  create    Generate firewall reject rules.
  stop      Undo firewall reject rules.
  resume    Resume enforcement of cached firewall reject rules.
EOF
}

print_linux_systemd_unit_file()
{
	local name_program="$1"
	local fpath_ruleset="$2"

	cat <<EOF
[Unit]
Description=$name_program - ASN IP outbound traffic blocker
After=network-online.target

[Service]
Type=oneshot
ExecStartPre=sirubo create
ExecStart=/usr/sbin/nft -f "$fpath_ruleset"

[Install]
WantedBy=multi-user.target
EOF
}

main "$@"
